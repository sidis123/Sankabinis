@model Sankabinis.Models.RaceParticipantsViewModel

@{
    ViewBag.Title = "Match";
    var raceId = ViewBag.RaceId;
    var loggedInUserId = ViewBag.LoggedInUserId;
    var username = Context.Session.GetString("Username");
}

<h2>Race ID: @raceId</h2>

<div>
    <h4>Race Information</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            Track
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.TrackId)
        </dd>
        <dt class="col-sm-2">
            Time
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.pasiulytas_laikas)
        </dd>
        <dt class="col-sm-2">
            Time confirmation
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.ar_laikas_patvirtintas)
        </dd>
        <dt class="col-sm-2">
            User 1
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.User1Id)
        </dd>
        <dt class="col-sm-2">
            User 2
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.User2Id)
        </dd>
        <dt class="col-sm-2">
            Car class
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Race.Automobilio_klase)
        </dd>
        </dd>
    </dl>
</div>

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}
else
{
    <div id="raceStatus"></div>
}

@if(Model.Race.ar_laikas_patvirtintas == true)
{
@section Scripts {
    <script>
        $(document).ready(function () {
            // Get the race data via AJAX
            $.ajax({
                url: '@Url.Action("GetDataAboutRace", "Race", new { raceId = raceId })',
                type: 'GET',
                success: function (race) {
                    if (race) {
                        if (race.ar_lenktynes_pasibaigusios) {
                            if (race.ar_galutinis_rezultatas) {
                                var winnerId = "";
                                if (race.rezultatas_pagal_pirmaji_naudotoja == 1 && race.rezultatas_pagal_antraji_naudotoja != 1) {
                                    winnerId = race.user1Id;
                                } else if (race.rezultatas_pagal_antraji_naudotoja == 1 && race.rezultatas_pagal_pirmaji_naudotoja != 1) {
                                    winnerId = race.user2Id;
                                }

                                if (winnerId) {
                                    // Fetch winner details
                                    $.ajax({
                                        url: '@Url.Action("GetDataAboutRacer", "Race")',
                                        type: 'GET',
                                        data: { id: winnerId },
                                        success: function (user) {
                                            if (user) {
                                                $('#raceStatus').html('<h2>The race has ended</h2><p>The winner is: ' + user.vardas_pavarde + '</p>');
                                            } else {
                                                $('#raceStatus').html('<h2>The race has ended</h2><p>The winner is: ' + winnerId + ' (user details not found)</p>');
                                            }

                                            // Check for achievements
                                            if (race.ar_gavo_pirmas) {
                                                $.ajax({
                                                    url: '@Url.Action("GetDataAboutRacer", "Race")',
                                                    type: 'GET',
                                                    data: { id: race.user1Id },
                                                    success: function (user1) {
                                                        if (user1) {
                                                            $('#raceStatus').append('<p>' + user1.vardas_pavarde + ' has got an achievement. Please check your achievements.</p>');
                                                        } else {
                                                            $('#raceStatus').append('<p>User 1 has got an achievement. Please check your achievements.</p>');
                                                        }
                                                    }
                                                });
                                            }
                                            if (race.ar_gavo_antras) {
                                                $.ajax({
                                                    url: '@Url.Action("GetDataAboutRacer", "Race")',
                                                    type: 'GET',
                                                    data: { id: race.user2Id },
                                                    success: function (user2) {
                                                        if (user2) {
                                                            $('#raceStatus').append('<p>' + user2.vardas_pavarde + ' has got an achievement. Please check your new achievements.</p>');
                                                        } else {
                                                            $('#raceStatus').append('<p>User 2 has got an achievement. Please check your new achievements.</p>');
                                                        }
                                                    }
                                                });
                                            }
                                        },
                                        error: function () {
                                            $('#raceStatus').html('<h2>The race has ended</h2><p>An error occurred while fetching the winner details.</p>');

                                            // Check for achievements
                                            if (race.ar_gavo_pirmas) {
                                                $.ajax({
                                                    url: '@Url.Action("GetDataAboutRacer", "Race")',
                                                    type: 'GET',
                                                    data: { id: race.user1Id },
                                                    success: function (user1) {
                                                        if (user1) {
                                                            $('#raceStatus').append('<p>' + user1.vardas_pavarde + ' has got an achievement. Please check your achievements.</p>');
                                                        } else {
                                                            $('#raceStatus').append('<p>User 1 has got an achievement. Please check your achievements.</p>');
                                                        }
                                                    }
                                                });
                                            }
                                            if (race.ar_gavo_antras) {
                                                $.ajax({
                                                    url: '@Url.Action("GetDataAboutRacer", "Race")',
                                                    type: 'GET',
                                                    data: { id: race.user2Id },
                                                    success: function (user2) {
                                                        if (user2) {
                                                            $('#raceStatus').append('<p>' + user2.vardas_pavarde + ' has got an achievement. Please check your new achievements.</p>');
                                                        } else {
                                                            $('#raceStatus').append('<p>User 2 has got an achievement. Please check your new achievements.</p>');
                                                        }
                                                    }
                                                });
                                            }
                                        }
                                    });
                                } else {
                                    $('#raceStatus').html('<h2>The race has ended</h2>');
                                }
                            } else {
                                $('#raceStatus').html('<h2>The race has ended</h2><p>One of the racers was dishonest. An appeal was created, please wait while the admin approves the final score.</p>');
                            }
                        } else {
                            // Race is still ongoing, show the form
                            $('#raceStatus').html('<div class="form-group">' +
                                '<form id="matchForm">' +
                                '<div class="form-check">' +
                                '<input type="radio" name="result" id="won" value="1" class="form-check-input" />' +
                                '<label class="form-check-label" for="won">I won the race</label>' +
                                '</div>' +
                                '<div class="form-check">' +
                                '<input type="radio" name="result" id="lost" value="0" class="form-check-input" />' +
                                '<label class="form-check-label" for="lost">I lost the race</label>' +
                                '</div>' +
                                '<div>' +
                                '<button type="button" id="submitResult" class="btn btn-primary" disabled>Submit Result</button>' +
                                '</div>' +
                                '</form>' +
                                '</div>');

                            // Enable/disable submit button based on radio selection
                            $('input[name="result"]').change(function () {
                                $('#submitResult').prop('disabled', false);
                            });

                            // Submit result
                            $('#submitResult').click(function () {
                                var selectedResult = $('input[name="result"]:checked').val();

                                // Perform validation if a result is selected
                                if (selectedResult === undefined) {
                                    alert('Please select a result.');
                                    return;
                                }

                                // AJAX call to submit result
                                $.ajax({
                                    url: '@Url.Action("RegisterResult", "Race")',
                                    type: 'POST',
                                    data: {
                                        userId: '@loggedInUserId',
                                        result: selectedResult,
                                        raceId: '@raceId'
                                    },
                                    success: function (response) {
                                        if (response.success) {
                                            alert('Result registered successfully.');
                                            location.reload(); // Refresh the page
                                        } else {
                                            alert('Failed to register result: ' + response.message);
                                        }
                                    },
                                    error: function () {
                                        alert('An error occurred while registering the result.');
                                    }
                                });
                            });
                        }
                    } else {
                        alert('Race data not found.');
                    }
                },
                error: function () {
                    alert('An error occurred while fetching race data.');
                }
            });
        });
    </script>


}

@if(Model.Race.ar_galutinis_rezultatas == true && Model.Race.ar_lenktynes_pasibaigusios == true && Model.Race.rezultatas_pagal_pirmaji_naudotoja == Model.Race.rezultatas_pagal_antraji_naudotoja)
{
        <p>@Html.DisplayFor(model => model.Appeal.Paaiskinimas)</p>
}

}