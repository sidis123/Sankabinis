@{
    ViewBag.Title = "Match";
    var raceId = ViewBag.RaceId;
    var loggedInUserId = ViewBag.LoggedInUserId;
    var username = Context.Session.GetString("Username");
}

<h2>Race ID: @raceId</h2>

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}
else
{
    <div id="raceStatus"></div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // Get the race data via AJAX
            $.ajax({
                url: '@Url.Action("GetDataAboutRace", "Race", new { raceId = raceId })',
                type: 'GET',
                success: function (race) {
                    if (race && race.ar_lenktynes_pasibaigusios) {
                        var winnerId = "";
                        if (race.rezultatas_pagal_pirmaji_naudotoja == 1 && race.rezultatas_pagal_antraji_naudotoja != 1) {
                            winnerId = race.user1Id;
                        } else if (race.rezultatas_pagal_antraji_naudotoja == 1 && race.rezultatas_pagal_pirmaji_naudotoja != 1) {
                            winnerId = race.user2Id;
                        }

                        if (winnerId) {
                            // Fetch winner details
                            $.ajax({
                                url: '@Url.Action("GetDataAboutRacer", "Race")',
                                type: 'GET',
                                data: { id: winnerId },
                                success: function (user) {
                                    if (user) {
                                        $('#raceStatus').html('<h2>The race has ended</h2><p>The winner is: ' + user.vardas_pavarde + '</p>');
                                    } else {
                                        $('#raceStatus').html('<h2>The race has ended</h2><p>The winner is: ' + winnerId + ' (user details not found)</p>');
                                    }
                                },
                                error: function () {
                                    $('#raceStatus').html('<h2>The race has ended</h2><p>An error occurred while fetching the winner details.</p>');
                                }
                            });
                        } else {
                            $('#raceStatus').html('<h2>The race has ended</h2><p>No winner determined.</p>');
                        }
                    } else {
                        // Race is still ongoing, show the form
                        $('#raceStatus').html('<div class="form-group">' +
                            '<form id="matchForm">' +
                            '<div class="form-check">' +
                            '<input type="radio" name="result" id="won" value="1" class="form-check-input" />' +
                            '<label class="form-check-label" for="won">I won the race</label>' +
                            '</div>' +
                            '<div class="form-check">' +
                            '<input type="radio" name="result" id="lost" value="0" class="form-check-input" />' +
                            '<label class="form-check-label" for="lost">I lost the race</label>' +
                            '</div>' +
                            '<div>' +
                            '<button type="button" id="submitResult" class="btn btn-primary" disabled>Submit Result</button>' +
                            '</div>' +
                            '</form>' +
                            '</div>');

                        // Enable/disable submit button based on radio selection
                        $('input[name="result"]').change(function () {
                            $('#submitResult').prop('disabled', false);
                        });

                        // Submit result
                        $('#submitResult').click(function () {
                            var selectedResult = $('input[name="result"]:checked').val();

                            // Perform validation if a result is selected
                            if (selectedResult === undefined) {
                                alert('Please select a result.');
                                return;
                            }

                            // AJAX call to submit result
                            $.ajax({
                                url: '@Url.Action("RegisterResult", "Race")',
                                type: 'POST',
                                data: {
                                    userId: '@loggedInUserId',
                                    result: selectedResult,
                                    raceId: '@raceId'
                                },
                                success: function (response) {
                                    if (response.success) {
                                        alert('Result registered successfully.');
                                        location.reload(); // Refresh the page
                                    } else {
                                        alert('Failed to register result: ' + response.message);
                                    }
                                },
                                error: function () {
                                    alert('An error occurred while registering the result.');
                                }
                            });
                        });
                    }
                },
                error: function () {
                    alert('An error occurred while fetching race data.');
                }
            });
        });
    </script>
}